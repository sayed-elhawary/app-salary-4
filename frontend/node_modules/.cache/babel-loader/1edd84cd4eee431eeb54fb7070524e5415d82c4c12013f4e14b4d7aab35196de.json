{"ast":null,"code":"import React,{createContext,useState,useEffect,useCallback}from'react';import{useNavigate}from'react-router-dom';import axios from'axios';import{jsx as _jsx}from\"react/jsx-runtime\";export const AuthContext=/*#__PURE__*/createContext();const AuthProvider=_ref=>{let{children}=_ref;const[user,setUser]=useState(null);const[loading,setLoading]=useState(true);const navigate=useNavigate();if(!process.env.REACT_APP_API_URL){console.error('REACT_APP_API_URL is not defined in environment variables');throw new Error('REACT_APP_API_URL is required');}const checkAuth=async function(){let retries=arguments.length>0&&arguments[0]!==undefined?arguments[0]:2;let delay=arguments.length>1&&arguments[1]!==undefined?arguments[1]:500;const token=localStorage.getItem('token');if(!token){console.log('No token found in localStorage');setUser(null);setLoading(false);return;}const controller=new AbortController();try{console.log('Sending request to /api/users/me with token:',token.substring(0,20)+'...');const res=await axios.get(\"\".concat(process.env.REACT_APP_API_URL,\"/api/users/me\"),{headers:{Authorization:\"Bearer \".concat(token)},signal:controller.signal});console.log('User fetched successfully:',res.data.user);setUser(res.data.user);}catch(err){var _err$response,_err$response$data,_err$response2,_err$response3,_err$response4,_err$response5,_err$response5$data;if(err.code==='ERR_CANCELED'){console.log('Request to /api/users/me was canceled');return;}console.error('Error verifying token:',{message:((_err$response=err.response)===null||_err$response===void 0?void 0:(_err$response$data=_err$response.data)===null||_err$response$data===void 0?void 0:_err$response$data.message)||err.message,status:(_err$response2=err.response)===null||_err$response2===void 0?void 0:_err$response2.status,url:\"\".concat(process.env.REACT_APP_API_URL,\"/api/users/me\"),responseData:(_err$response3=err.response)===null||_err$response3===void 0?void 0:_err$response3.data});// محاولة تجديد الرمز إذا كان الخطأ 401\nif(((_err$response4=err.response)===null||_err$response4===void 0?void 0:_err$response4.status)===401&&retries>0){try{console.log('Attempting to refresh token');const refreshRes=await axios.post(\"\".concat(process.env.REACT_APP_API_URL,\"/api/auth/refresh\"),{token});const newToken=refreshRes.data.token;localStorage.setItem('token',newToken);localStorage.setItem('tokenTimestamp',Date.now().toString());console.log('Token refreshed, retrying /api/users/me');return checkAuth(retries-1,delay);}catch(refreshErr){var _refreshErr$response,_refreshErr$response$;console.error('Token refresh failed:',((_refreshErr$response=refreshErr.response)===null||_refreshErr$response===void 0?void 0:(_refreshErr$response$=_refreshErr$response.data)===null||_refreshErr$response$===void 0?void 0:_refreshErr$response$.message)||refreshErr.message);}}// إذا كان الرمز جديدًا (أقل من 5 ثوانٍ)، تجنب إعادة التوجيه\nconst tokenTimestamp=localStorage.getItem('tokenTimestamp');if(tokenTimestamp&&Date.now()-parseInt(tokenTimestamp)<5000){console.log('Token is fresh, skipping redirect to /login');setUser(null);setLoading(false);return;}if(retries>0){console.log(\"Retrying /api/users/me, attempts left: \".concat(retries));await new Promise(resolve=>setTimeout(resolve,delay));return checkAuth(retries-1,delay*2);}localStorage.removeItem('token');localStorage.removeItem('tokenTimestamp');setUser(null);navigate('/login',{replace:true,state:{error:((_err$response5=err.response)===null||_err$response5===void 0?void 0:(_err$response5$data=_err$response5.data)===null||_err$response5$data===void 0?void 0:_err$response5$data.message)||'انتهت صلاحية الجلسة، يرجى تسجيل الدخول مرة أخرى'}});}finally{setLoading(false);}return()=>controller.abort();};useEffect(()=>{checkAuth().catch(err=>console.error('CheckAuth failed:',err));},[navigate]);const login=useCallback(async(code,password)=>{try{console.log('Attempting login with code:',code);const res=await axios.post(\"\".concat(process.env.REACT_APP_API_URL,\"/api/auth/login\"),{code,password});console.log('Login successful, user:',res.data.user);localStorage.setItem('token',res.data.token);localStorage.setItem('tokenTimestamp',Date.now().toString());setUser(res.data.user);setLoading(false);navigate('/dashboard',{replace:true});}catch(err){var _err$response6,_err$response6$data,_err$response7;console.error('Login error:',{message:((_err$response6=err.response)===null||_err$response6===void 0?void 0:(_err$response6$data=_err$response6.data)===null||_err$response6$data===void 0?void 0:_err$response6$data.message)||err.message,status:(_err$response7=err.response)===null||_err$response7===void 0?void 0:_err$response7.status});throw err;}},[navigate]);const logout=useCallback(()=>{console.log('Logging out, removing token and timestamp');localStorage.removeItem('token');localStorage.removeItem('tokenTimestamp');setUser(null);navigate('/login',{replace:true,state:{error:'تم تسجيل الخروج بنجاح'}});},[navigate]);return/*#__PURE__*/_jsx(AuthContext.Provider,{value:{user,login,logout,loading,setUser},children:children});};export default AuthProvider;","map":{"version":3,"names":["React","createContext","useState","useEffect","useCallback","useNavigate","axios","jsx","_jsx","AuthContext","AuthProvider","_ref","children","user","setUser","loading","setLoading","navigate","process","env","REACT_APP_API_URL","console","error","Error","checkAuth","retries","arguments","length","undefined","delay","token","localStorage","getItem","log","controller","AbortController","substring","res","get","concat","headers","Authorization","signal","data","err","_err$response","_err$response$data","_err$response2","_err$response3","_err$response4","_err$response5","_err$response5$data","code","message","response","status","url","responseData","refreshRes","post","newToken","setItem","Date","now","toString","refreshErr","_refreshErr$response","_refreshErr$response$","tokenTimestamp","parseInt","Promise","resolve","setTimeout","removeItem","replace","state","abort","catch","login","password","_err$response6","_err$response6$data","_err$response7","logout","Provider","value"],"sources":["/root/app/salary-6/frontend/src/components/AuthProvider.js"],"sourcesContent":["import React, { createContext, useState, useEffect, useCallback } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport axios from 'axios';\n\nexport const AuthContext = createContext();\n\nconst AuthProvider = ({ children }) => {\n  const [user, setUser] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const navigate = useNavigate();\n\n  if (!process.env.REACT_APP_API_URL) {\n    console.error('REACT_APP_API_URL is not defined in environment variables');\n    throw new Error('REACT_APP_API_URL is required');\n  }\n\n  const checkAuth = async (retries = 2, delay = 500) => {\n    const token = localStorage.getItem('token');\n    if (!token) {\n      console.log('No token found in localStorage');\n      setUser(null);\n      setLoading(false);\n      return;\n    }\n\n    const controller = new AbortController();\n    try {\n      console.log('Sending request to /api/users/me with token:', token.substring(0, 20) + '...');\n      const res = await axios.get(`${process.env.REACT_APP_API_URL}/api/users/me`, {\n        headers: { Authorization: `Bearer ${token}` },\n        signal: controller.signal,\n      });\n      console.log('User fetched successfully:', res.data.user);\n      setUser(res.data.user);\n    } catch (err) {\n      if (err.code === 'ERR_CANCELED') {\n        console.log('Request to /api/users/me was canceled');\n        return;\n      }\n      console.error('Error verifying token:', {\n        message: err.response?.data?.message || err.message,\n        status: err.response?.status,\n        url: `${process.env.REACT_APP_API_URL}/api/users/me`,\n        responseData: err.response?.data,\n      });\n\n      // محاولة تجديد الرمز إذا كان الخطأ 401\n      if (err.response?.status === 401 && retries > 0) {\n        try {\n          console.log('Attempting to refresh token');\n          const refreshRes = await axios.post(`${process.env.REACT_APP_API_URL}/api/auth/refresh`, { token });\n          const newToken = refreshRes.data.token;\n          localStorage.setItem('token', newToken);\n          localStorage.setItem('tokenTimestamp', Date.now().toString());\n          console.log('Token refreshed, retrying /api/users/me');\n          return checkAuth(retries - 1, delay);\n        } catch (refreshErr) {\n          console.error('Token refresh failed:', refreshErr.response?.data?.message || refreshErr.message);\n        }\n      }\n\n      // إذا كان الرمز جديدًا (أقل من 5 ثوانٍ)، تجنب إعادة التوجيه\n      const tokenTimestamp = localStorage.getItem('tokenTimestamp');\n      if (tokenTimestamp && Date.now() - parseInt(tokenTimestamp) < 5000) {\n        console.log('Token is fresh, skipping redirect to /login');\n        setUser(null);\n        setLoading(false);\n        return;\n      }\n\n      if (retries > 0) {\n        console.log(`Retrying /api/users/me, attempts left: ${retries}`);\n        await new Promise((resolve) => setTimeout(resolve, delay));\n        return checkAuth(retries - 1, delay * 2);\n      }\n\n      localStorage.removeItem('token');\n      localStorage.removeItem('tokenTimestamp');\n      setUser(null);\n      navigate('/login', {\n        replace: true,\n        state: { error: err.response?.data?.message || 'انتهت صلاحية الجلسة، يرجى تسجيل الدخول مرة أخرى' },\n      });\n    } finally {\n      setLoading(false);\n    }\n    return () => controller.abort();\n  };\n\n  useEffect(() => {\n    checkAuth().catch((err) => console.error('CheckAuth failed:', err));\n  }, [navigate]);\n\n  const login = useCallback(\n    async (code, password) => {\n      try {\n        console.log('Attempting login with code:', code);\n        const res = await axios.post(`${process.env.REACT_APP_API_URL}/api/auth/login`, {\n          code,\n          password,\n        });\n        console.log('Login successful, user:', res.data.user);\n        localStorage.setItem('token', res.data.token);\n        localStorage.setItem('tokenTimestamp', Date.now().toString());\n        setUser(res.data.user);\n        setLoading(false);\n        navigate('/dashboard', { replace: true });\n      } catch (err) {\n        console.error('Login error:', {\n          message: err.response?.data?.message || err.message,\n          status: err.response?.status,\n        });\n        throw err;\n      }\n    },\n    [navigate]\n  );\n\n  const logout = useCallback(() => {\n    console.log('Logging out, removing token and timestamp');\n    localStorage.removeItem('token');\n    localStorage.removeItem('tokenTimestamp');\n    setUser(null);\n    navigate('/login', { replace: true, state: { error: 'تم تسجيل الخروج بنجاح' } });\n  }, [navigate]);\n\n  return (\n    <AuthContext.Provider value={{ user, login, logout, loading, setUser }}>\n      {children}\n    </AuthContext.Provider>\n  );\n};\n\nexport default AuthProvider;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}