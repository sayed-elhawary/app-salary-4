{"ast":null,"code":"import React,{createContext,useState,useEffect,useCallback}from'react';import{useNavigate}from'react-router-dom';import axios from'axios';import{jsx as _jsx}from\"react/jsx-runtime\";export const AuthContext=/*#__PURE__*/createContext();const AuthProvider=_ref=>{let{children}=_ref;const[user,setUser]=useState(null);const[loading,setLoading]=useState(true);const navigate=useNavigate();if(!process.env.REACT_APP_API_URL){console.error('REACT_APP_API_URL is not defined in environment variables');throw new Error('REACT_APP_API_URL is required');}const checkAuth=async function(){let retries=arguments.length>0&&arguments[0]!==undefined?arguments[0]:2;let delay=arguments.length>1&&arguments[1]!==undefined?arguments[1]:1000;const token=localStorage.getItem('token');if(!token){console.log('No token found in localStorage');setUser(null);setLoading(false);return;}const controller=new AbortController();try{console.log('Sending request to /api/users/me with token:',token.substring(0,20)+'...');const res=await axios.get(\"\".concat(process.env.REACT_APP_API_URL,\"/api/users/me\"),{headers:{Authorization:\"Bearer \".concat(token)},signal:controller.signal});console.log('User fetched successfully:',res.data.user);setUser(res.data.user);}catch(err){var _err$response,_err$response$data,_err$response2;if(err.code==='ERR_CANCELED'){console.log('Request to /api/users/me was canceled');return;}if(retries>0){console.log(\"Retrying /api/users/me, attempts left: \".concat(retries));await new Promise(resolve=>setTimeout(resolve,delay));return checkAuth(retries-1,delay*2);}console.error('Error verifying token:',{message:((_err$response=err.response)===null||_err$response===void 0?void 0:(_err$response$data=_err$response.data)===null||_err$response$data===void 0?void 0:_err$response$data.message)||err.message,status:(_err$response2=err.response)===null||_err$response2===void 0?void 0:_err$response2.status,url:\"\".concat(process.env.REACT_APP_API_URL,\"/api/users/me\")});localStorage.removeItem('token');setUser(null);navigate('/login',{replace:true});}finally{setLoading(false);}return()=>controller.abort();};useEffect(()=>{checkAuth().catch(err=>console.error('CheckAuth failed:',err));},[navigate]);const login=useCallback(async(code,password)=>{try{console.log('Attempting login with code:',code);const res=await axios.post(\"\".concat(process.env.REACT_APP_API_URL,\"/api/auth/login\"),{code,password});console.log('Login successful, user:',res.data.user);localStorage.setItem('token',res.data.token);setUser(res.data.user);setLoading(false);navigate('/dashboard',{replace:true});}catch(err){var _err$response3,_err$response3$data,_err$response4;console.error('Login error:',{message:((_err$response3=err.response)===null||_err$response3===void 0?void 0:(_err$response3$data=_err$response3.data)===null||_err$response3$data===void 0?void 0:_err$response3$data.message)||err.message,status:(_err$response4=err.response)===null||_err$response4===void 0?void 0:_err$response4.status});throw err;}},[navigate]);const logout=useCallback(()=>{console.log('Logging out, removing token');localStorage.removeItem('token');setUser(null);navigate('/login',{replace:true});},[navigate]);return/*#__PURE__*/_jsx(AuthContext.Provider,{value:{user,login,logout,loading,setUser},children:children});};export default AuthProvider;","map":{"version":3,"names":["React","createContext","useState","useEffect","useCallback","useNavigate","axios","jsx","_jsx","AuthContext","AuthProvider","_ref","children","user","setUser","loading","setLoading","navigate","process","env","REACT_APP_API_URL","console","error","Error","checkAuth","retries","arguments","length","undefined","delay","token","localStorage","getItem","log","controller","AbortController","substring","res","get","concat","headers","Authorization","signal","data","err","_err$response","_err$response$data","_err$response2","code","Promise","resolve","setTimeout","message","response","status","url","removeItem","replace","abort","catch","login","password","post","setItem","_err$response3","_err$response3$data","_err$response4","logout","Provider","value"],"sources":["/root/app/salary-6/frontend/src/components/AuthProvider.js"],"sourcesContent":["import React, { createContext, useState, useEffect, useCallback } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport axios from 'axios';\n\nexport const AuthContext = createContext();\n\nconst AuthProvider = ({ children }) => {\n  const [user, setUser] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const navigate = useNavigate();\n\n  if (!process.env.REACT_APP_API_URL) {\n    console.error('REACT_APP_API_URL is not defined in environment variables');\n    throw new Error('REACT_APP_API_URL is required');\n  }\n\n  const checkAuth = async (retries = 2, delay = 1000) => {\n    const token = localStorage.getItem('token');\n    if (!token) {\n      console.log('No token found in localStorage');\n      setUser(null);\n      setLoading(false);\n      return;\n    }\n\n    const controller = new AbortController();\n    try {\n      console.log('Sending request to /api/users/me with token:', token.substring(0, 20) + '...');\n      const res = await axios.get(`${process.env.REACT_APP_API_URL}/api/users/me`, {\n        headers: { Authorization: `Bearer ${token}` },\n        signal: controller.signal,\n      });\n      console.log('User fetched successfully:', res.data.user);\n      setUser(res.data.user);\n    } catch (err) {\n      if (err.code === 'ERR_CANCELED') {\n        console.log('Request to /api/users/me was canceled');\n        return;\n      }\n      if (retries > 0) {\n        console.log(`Retrying /api/users/me, attempts left: ${retries}`);\n        await new Promise((resolve) => setTimeout(resolve, delay));\n        return checkAuth(retries - 1, delay * 2);\n      }\n      console.error('Error verifying token:', {\n        message: err.response?.data?.message || err.message,\n        status: err.response?.status,\n        url: `${process.env.REACT_APP_API_URL}/api/users/me`,\n      });\n      localStorage.removeItem('token');\n      setUser(null);\n      navigate('/login', { replace: true });\n    } finally {\n      setLoading(false);\n    }\n    return () => controller.abort();\n  };\n\n  useEffect(() => {\n    checkAuth().catch((err) => console.error('CheckAuth failed:', err));\n  }, [navigate]);\n\n  const login = useCallback(\n    async (code, password) => {\n      try {\n        console.log('Attempting login with code:', code);\n        const res = await axios.post(`${process.env.REACT_APP_API_URL}/api/auth/login`, {\n          code,\n          password,\n        });\n        console.log('Login successful, user:', res.data.user);\n        localStorage.setItem('token', res.data.token);\n        setUser(res.data.user);\n        setLoading(false);\n        navigate('/dashboard', { replace: true });\n      } catch (err) {\n        console.error('Login error:', {\n          message: err.response?.data?.message || err.message,\n          status: err.response?.status,\n        });\n        throw err;\n      }\n    },\n    [navigate]\n  );\n\n  const logout = useCallback(() => {\n    console.log('Logging out, removing token');\n    localStorage.removeItem('token');\n    setUser(null);\n    navigate('/login', { replace: true });\n  }, [navigate]);\n\n  return (\n    <AuthContext.Provider value={{ user, login, logout, loading, setUser }}>\n      {children}\n    </AuthContext.Provider>\n  );\n};\n\nexport default AuthProvider;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}